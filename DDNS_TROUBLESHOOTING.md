# DDNS接続トラブルシューティング

## 現在の状況

### DDNSドメイン
- **ドメイン**: tmhk-chat.ddns.net
- **解決先IP**: 52.69.241.31 (正常に解決されています)
- **EC2インスタンス**: 停止中または応答なし

### エラー内容
```
ERR_CONNECTION_TIMED_OUT
このサイトにアクセスできません
tmhk-chat.ddns.net からの応答時間が長すぎます
```

## 解決手順

### 1. EC2インスタンスの起動

1. AWS EC2コンソールにアクセス:
   ```
   https://ap-northeast-1.console.aws.amazon.com/ec2/home?region=ap-northeast-1#Instances:
   ```

2. インスタンスを選択して「インスタンスの状態」→「インスタンスを開始」をクリック

3. インスタンスのステータスが「running」になるまで待つ（約1-2分）

### 2. セキュリティグループの確認

インバウンドルールで以下のポートが開いているか確認:

| タイプ | プロトコル | ポート範囲 | ソース |
|--------|-----------|-----------|--------|
| SSH | TCP | 22 | 0.0.0.0/0 |
| カスタムTCP | TCP | 5000 | 0.0.0.0/0 |
| HTTP | TCP | 80 | 0.0.0.0/0 |
| HTTPS | TCP | 443 | 0.0.0.0/0 |

### 3. インスタンス起動後の確認

インスタンスが起動したら、接続テストを実行:

```cmd
ping tmhk-chat.ddns.net -n 4
```

成功すれば次のように表示されます:
```
応答: バイト数 =32 時間 <10ms TTL=xxx
```

### 4. アプリケーションのデプロイ

インスタンスが起動したら、デプロイスクリプトを実行:

```cmd
DEPLOY_NOW.bat
```

または手動でSSH接続:

```cmd
ssh -i "C:\Users\skyto\ARE\tmhk-chat.pem" ubuntu@52.69.241.31
```

### 5. ブラウザでアクセス

デプロイ完了後、以下のURLにアクセス:

```
http://tmhk-chat.ddns.net:5000
```

または

```
http://52.69.241.31:5000
```

## DDNSサービスの設定確認

### No-IPの設定（参考）

DDNSサービス（No-IPなど）を使用している場合:

1. No-IPのアカウントにログイン
2. ホスト名 `tmhk-chat.ddns.net` の設定を確認
3. IPアドレスが `52.69.241.31` に正しく設定されているか確認
4. 必要に応じてDUC（Dynamic Update Client）を設定

## よくある問題

### Q: インスタンスは起動しているのに接続できない
A: セキュリティグループのインバウンドルールを確認してください。特にポート5000が開いているか確認。

### Q: DDNSのIPアドレスが更新されない
A: EC2インスタンスにElastic IPを割り当てると、IPアドレスが固定されるため安定します。

### Q: ポート5000でアクセスできない
A: 
1. PM2でアプリケーションが起動しているか確認: `pm2 status`
2. Flaskアプリが正しくバインドされているか確認: `netstat -tlnp | grep 5000`

## コスト削減のヒント

EC2インスタンスは起動中に課金されます:
- **使用しない時は停止する**: インスタンスを停止すると、コンピューティング料金は発生しません
- **ストレージ料金は継続**: EBSボリュームの料金は停止中も発生します
- **Elastic IP**: 割り当て後、インスタンスに関連付けていない場合は料金が発生します

## 自動起動の設定（オプション）

インスタンスを常時起動する場合、PM2で自動起動を設定:

```bash
# PM2を起動時に自動実行
pm2 startup systemd
sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu

# 現在の設定を保存
pm2 save
```

## 現在のデプロイ状況

- **GitHubリポジトリ**: https://github.com/sakai-tomohiko124/tmhk-chat-server
- **最新コミット**: すべての変更がプッシュ済み
- **サイドメニュー**: 全HTMLファイルに追加済み
- **待機中**: EC2インスタンスの起動とデプロイ実行

---

**次のステップ**: AWS EC2コンソールでインスタンスを起動してから、`DEPLOY_NOW.bat` を実行してください。
