# 「TMHKchat」開発・運用マニュアル

**作成日:** 2025年9月28日  
**バージョン:** 1.0

## 1. 開発の流れ（一番よく使う手順）

この手順は、パソコンで修正したプログラムを、インターネット上のサーバーに反映させるときに毎回使います。

### ステップ1: パソコンでプログラムを修正する

まず、自分のパソコンでプログラムの修正や機能追加を行います。

#### 作業フォルダを開く
```
C:\Users\skyto\Documents\server
```

#### ファイルを編集する
- **プログラム本体:** `abcd.py`
- **HTMLなど画面の見た目:** `templates` フォルダ内のファイル
- **使いたい部品（ライブラリ）を追加した場合:** `requirements.txt` に名前を追記

#### （もしあれば）不要なファイルを削除する
エクスプローラーでファイルを右クリックして削除するだけでOKです。

### ステップ2: 修正内容をGitHubに記録・保管する

次に、パソコンでの修正内容をGitHubにアップロードします。作業は Git Bash で行います。

#### 1. ターミナル（Git Bash）を開き、作業フォルダに移動する
```bash
cd ~/Documents/server
```

#### 2. 変更したファイルを確認する（任意）
```bash
git status
```

#### 3. 全ての変更を記録の対象にする
```bash
git add .
```

#### 4. 変更内容にメモ（コミットメッセージ）を付けて記録を確定する
```bash
git commit -m "〇〇の機能を追加"
```
※ 「」の中身は、何を変更したか分かるように具体的に書くと後で見返したときに便利です。

#### 5. GitHubにアップロードする
```bash
git push origin main
```

### ステップ3: サーバーに修正内容を反映させる

最後に、GitHubにアップロードした最新のプログラムを、AWSサーバーにダウンロードして動かします。

#### 1. サーバーに接続する（SSH接続）
```bash
ssh -i "tmhk-chat.pem" ubuntu@52.69.241.31
```
※ `tmhk-chat.pem` ファイルがあるフォルダで実行してください。

#### 2. 作業フォルダに移動する
```bash
cd ~/tmhk-chat-server
```

#### 3. GitHubから最新のプログラムをダウンロードする
```bash
git pull origin main
```

#### 4. （もしあれば）新しい部品（ライブラリ）をインストールする
※ `requirements.txt` を変更した場合のみ、この手順が必要です。
```bash
source venv/bin/activate
pip install -r requirements.txt
```

#### 5. アプリを再起動して、修正を反映させる
```bash
pm2 restart tmhk-chat
```

これで、Webサイトが新しいバージョンに更新されます。

---

## 2. サーバーの動作確認（様子がおかしいとき）

アプリがうまく動かない、エラーが出ているかもしれない、というときに使います。

### アプリの状態を確認する
サーバーに接続後、以下のコマンドを実行します：
```bash
pm2 list
```

- `status` が `online` なら正常に動いています。
- `status` が `errored` や `stopped` になっていたら、何か問題が起きています。

### エラーの原因（ログ）を確認する
```bash
pm2 logs tmhk-chat
```

- エラーメッセージが表示されるので、その内容をヒントに原因を探ります。
- ログ表示を止めるときは `Ctrl + C` を押します。

---

## 3. トラブルシューティング

### よくある問題と解決方法

#### アプリが起動しない場合
```bash
# 1. エラーログを確認
pm2 logs tmhk-chat

# 2. アプリを強制再起動
pm2 restart tmhk-chat --force

# 3. それでもダメな場合は完全に停止してから再起動
pm2 stop tmhk-chat
pm2 start tmhk-chat
```

#### データベースに関する問題
```bash
# データベースファイルの確認
ls -la abc.db

# 必要に応じてデータベースを再初期化
python abcd.py
```

#### 依存関係の問題
```bash
# 仮想環境をアクティベート
source venv/bin/activate

# 依存関係を再インストール
pip install -r requirements.txt --force-reinstall
```

---

## 4. 定期メンテナンス

### 月次タスク
- [ ] サーバーのディスク容量確認
- [ ] ログファイルのクリーンアップ
- [ ] データベースのバックアップ

### コマンド例
```bash
# ディスク容量確認
df -h

# ログファイルクリーンアップ
pm2 flush

# データベースバックアップ
cp abc.db abc_backup_$(date +%Y%m%d).db
```

---

## 5. 緊急時対応

### サーバーがダウンした場合
1. AWS EC2インスタンスの状態を確認
2. インスタンスの再起動
3. アプリケーションの再起動
4. 必要に応じてデータ復旧

### 連絡先
- **開発者:** sakai-tomohiko124
- **GitHub:** https://github.com/sakai-tomohiko124/tmhk-chat-server

---

*最終更新: 2025年10月6日*