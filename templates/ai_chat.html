<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIチャット - TMHKchat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        html, body { height: 100%; }
        body { display: flex; flex-direction: column; }
        .chat-header { flex-shrink: 0; }
        .chat-container { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .message-bubble { max-width: 80%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; word-wrap: break-word; display: flex; align-items: center; }
        .my-message { background-color: #007bff; color: white; margin-left: auto; }
        .ai-message { background-color: #e9e9eb; color: black; margin-right: auto; }
        .chat-form { flex-shrink: 0; }
        .typing-indicator { display: none; }
    </style>
</head>
<body>
    <header class="chat-header bg-light p-3 border-bottom d-flex justify-content-between align-items-center">
        <div>
            <a href="{{ url_for('main_app') }}" class="btn btn-secondary btn-sm"><i class="bi bi-arrow-left"></i></a>
            <strong class="ml-2"><i class="bi bi-robot"></i> AIチャット (Gemini)</strong>
        </div>
    </header>

    <div class="chat-container" id="chat-container">
        {% for msg in history %}
            <div class="message-bubble {{ 'my-message' if msg.sender_id == current_user.id else 'ai-message' }}">
                {{ msg.content | nl2br }}
            </div>
        {% endfor %}
        <div class="message-bubble ai-message typing-indicator" id="typing-indicator">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="sr-only">Typing...</span>
            </div>
            <span class="ml-2">AIが考え中...</span>
        </div>
    </div>

    <form class="chat-form p-3 bg-light border-top" id="message-form">
        <div class="input-group">
            <input type="text" id="message-input" class="form-control" placeholder="AIへの質問やメッセージを入力..." autocomplete="off">
            <div class="input-group-append">
                <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i></button>
            </div>
        </div>
    </form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const form = document.getElementById('message-form');
    const input = document.getElementById('message-input');
    const chatContainer = document.getElementById('chat-container');
    const typingIndicator = document.getElementById('typing-indicator');

    chatContainer.scrollTop = chatContainer.scrollHeight;

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
            const message = input.value;
            appendMessage(message, 'my-message');
            socket.emit('send_ai_message', { 'message': message });
            input.value = '';
            typingIndicator.style.display = 'flex';
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    });

    socket.on('ai_response', function(data) {
        typingIndicator.style.display = 'none';
        appendMessage(data.message, 'ai-message');
    });

    function appendMessage(content, className) {
        const messageBubble = document.createElement('div');
        messageBubble.classList.add('message-bubble', className);
        messageBubble.innerHTML = content.replace(/\\n/g, '<br>');
        chatContainer.insertBefore(messageBubble, typingIndicator);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
});
</script>
</body>
</html>
