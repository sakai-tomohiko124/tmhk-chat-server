<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>しりとり - TMHKchat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container my-4" style="max-width: 600px;">
    <a href="{{ url_for('games_hub') }}" class="btn btn-secondary mb-3">戻る</a>
    <h1 class="text-center">しりとり</h1>

    <div class="card">
        <div class="card-header">
            現在のターン: <strong id="turn-player"></strong>
        </div>
        <div class="card-body">
            <p>前の単語: <span id="current-word" class="h4">（開始待ち）</span></p>
            <p>次の文字: <span id="next-char" class="h4 text-danger"></span></p>
            <form id="word-form">
                <div class="input-group">
                    <input type="text" id="word-input" class="form-control" placeholder="言葉を入力" autocomplete="off" disabled>
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="submit" id="submit-btn" disabled>決定</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="mt-3">
        <h6>使用された言葉リスト</h6>
        <ul id="used-words-list" class="list-group" style="height: 150px; overflow-y: scroll;"></ul>
    </div>
    
    {% if room.host == current_user.id %}
    <button id="start-game-btn" class="btn btn-success mt-3">しりとり開始</button>
    {% endif %}
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const roomId = "{{ room_id }}";
    const currentUserId = {{ current_user.id }};
    const playerMap = { {% for p in room.players %}{{ p.id }}: '{{ p.name }}',{% endfor %} };

    const startBtn = document.getElementById('start-game-btn');
    const wordForm = document.getElementById('word-form');
    const wordInput = document.getElementById('word-input');
    const submitBtn = document.getElementById('submit-btn');
    const turnPlayer = document.getElementById('turn-player');
    const currentWord = document.getElementById('current-word');
    const nextChar = document.getElementById('next-char');
    const usedWordsList = document.getElementById('used-words-list');
    
    if(startBtn) {
        startBtn.addEventListener('click', () => {
            socket.emit('start_game', { room_id: roomId });
            startBtn.style.display = 'none';
        });
    }
    
    socket.on('connect', () => socket.emit('join_game', { room_id: roomId }));

    wordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if(wordInput.value) {
            socket.emit('submit_word', { room_id: roomId, word: wordInput.value });
            wordInput.value = '';
        }
    });

    socket.on('update_game_state', function(data) {
        turnPlayer.textContent = playerMap[data.current_turn];
        if (data.current_turn === currentUserId) {
            wordInput.disabled = false;
            submitBtn.disabled = false;
            wordInput.focus();
        } else {
            wordInput.disabled = true;
            submitBtn.disabled = true;
        }
        
        if(data.current_word) {
            currentWord.textContent = data.current_word;
            nextChar.textContent = data.last_char;
        }

        usedWordsList.innerHTML = '';
        data.used_words.forEach(word => {
            const li = document.createElement('li');
            li.className = 'list-group-item py-1';
            li.textContent = word;
            usedWordsList.appendChild(li);
        });
    });
    
    socket.on('invalid_word', function(data) {
        alert(data.message);
    });

    socket.on('game_over', function(data) {
        alert(data.message);
        wordInput.disabled = true;
        submitBtn.disabled = true;
    });
});
</script>
</body>
</html>
