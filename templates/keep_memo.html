<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>キープメモ - TMHKchat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        html, body { height: 100vh; overflow: hidden; }
        body { display: flex; flex-direction: column; }
        .chat-header { flex-shrink: 0; }
        .chat-container { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .message-row { display: flex; flex-direction: column; align-items: flex-end; }
        .message-bubble { max-width: 80%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; word-wrap: break-word; background-color: #dcf8c6; cursor: pointer; position: relative; }
        .message-content { padding-bottom: 15px; }
        .message-meta { position: absolute; bottom: 4px; right: 8px; font-size: 0.7em; color: #999; }
    </style>
</head>
<body>
    <header class="chat-header bg-light p-3 border-bottom d-flex justify-content-between align-items-center">
        <div>
            <a href="{{ url_for('main_app') }}" class="btn btn-secondary btn-sm"><i class="bi bi-arrow-left"></i></a>
            <strong class="ml-2"><i class="bi bi-journal-check"></i> キープメモ</strong>
        </div>
    </header>

    <div class="chat-container" id="chat-container">
        {% for message in messages %}
            <div id="message-row-{{ message.id }}" class="message-row">
                <div class="message-bubble" data-message-id="{{ message.id }}">
                    <div class="message-content">{{ message.content | nl2br }}</div>
                    <div class="message-meta">{{ message.timestamp | format_datetime('%H:%M') }}</div>
                </div>
            </div>
        {% endfor %}
    </div>

    <form class="chat-form p-3 bg-light border-top" id="message-form">
        <div class="input-group">
            <input type="text" id="message-input" class="form-control" placeholder="メモを入力..." autocomplete="off">
            <div class="input-group-append">
                <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i></button>
            </div>
        </div>
    </form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const form = document.getElementById('message-form');
    const input = document.getElementById('message-input');
    const chatContainer = document.getElementById('chat-container');
    const currentUserId = {{ current_user.id }};

    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    scrollToBottom();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
            socket.emit('send_private_message', { 'recipient_id': currentUserId, 'message': input.value });
            input.value = '';
        }
    });

    socket.on('new_private_message', function(msg) {
        if (msg.sender_id === currentUserId && msg.recipient_id === currentUserId) {
            const msgRow = `
            <div id="message-row-${msg.id}" class="message-row">
                <div class="message-bubble" data-message-id="${msg.id}">
                    <div class="message-content">${msg.content.replace(/\\n/g, '<br>')}</div>
                    <div class="message-meta">
                        ${new Date(msg.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                </div>
            </div>`;
            chatContainer.innerHTML += msgRow;
            scrollToBottom();
        }
    });
});
</script>
</body>
</html>
