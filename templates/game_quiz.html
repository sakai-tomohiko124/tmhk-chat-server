<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クイズ - TMHKchat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
<div class="container my-4">
    <a href="{{ url_for('games_hub') }}" class="btn btn-secondary mb-3">戻る</a>
    <h1 class="text-center">クイズバトル！</h1>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center" id="question-header">
                    <span>問題</span>
                    <span id="quiz-theme-display" class="badge badge-info"></span>
                </div>
                <div class="card-body">
                    <h4 id="question-text">ゲーム開始を待っています...</h4>
                    <div id="options-area" class="list-group mt-4"></div>
                </div>
                <div class="card-footer" id="result-area"></div>
            </div>
            {% if room.host == current_user.id %}
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-robot"></i> AIでクイズを作成</h5>
                    <div class="input-group">
                        <input type="text" id="quiz-theme-input" class="form-control" placeholder="クイズのテーマを入力 (例: 宇宙, 歴史)">
                        <div class="input-group-append">
                            <button id="generate-ai-quiz-btn" class="btn btn-outline-primary">生成</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="col-md-4">
            <h4>スコアボード</h4>
            <ul id="scoreboard" class="list-group">
                {% for player in room.players %}
                <li class="list-group-item d-flex justify-content-between align-items-center" id="score-{{ player.id }}">
                    {{ player.name }} <span class="badge badge-primary badge-pill">0</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% if room.host == current_user.id %}
    <button id="start-game-btn" class="btn btn-success mt-3">クイズ開始</button>
    {% endif %}
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const roomId = "{{ room_id }}";
    const startBtn = document.getElementById('start-game-btn');
    const qText = document.getElementById('question-text');
    const optsArea = document.getElementById('options-area');
    const resultArea = document.getElementById('result-area');
    const aiQuizBtn = document.getElementById('generate-ai-quiz-btn');
    const themeInput = document.getElementById('quiz-theme-input');
    const themeDisplay = document.getElementById('quiz-theme-display');

    if(startBtn) {
        startBtn.addEventListener('click', () => {
            socket.emit('start_game', { room_id: roomId });
            startBtn.style.display = 'none';
            if (aiQuizBtn) aiQuizBtn.closest('.card').style.display = 'none';
        });
    }

    if (aiQuizBtn) {
        aiQuizBtn.addEventListener('click', () => {
            const theme = themeInput.value.trim();
            if (theme) {
                socket.emit('generate_ai_quiz', { room_id: roomId, theme: theme });
                resultArea.textContent = 'AIがクイズを生成中です...';
            } else {
                alert('テーマを入力してください。');
            }
        });
    }
    
    socket.on('connect', () => socket.emit('join_game', { room_id: roomId }));

    socket.on('quiz_generated', function(data) {
        resultArea.textContent = `AIが「${data.theme}」のクイズを作成しました！`;
        themeDisplay.textContent = data.theme;
    });

    socket.on('ai_quiz_error', data => alert(data.message));
    
    socket.on('new_question', function(data) {
        qText.textContent = data.question;
        optsArea.innerHTML = '';
        resultArea.textContent = '';
        data.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.textContent = opt;
            btn.onclick = () => {
                socket.emit('submit_answer', { room_id: roomId, answer: opt });
                optsArea.querySelectorAll('button').forEach(b => b.disabled = true);
            };
            optsArea.appendChild(btn);
        });
    });

    socket.on('answer_result', function(data) {
        resultArea.textContent = data.is_correct ? "正解！" : "不正解...";
        resultArea.className = data.is_correct ? 'card-footer text-success' : 'card-footer text-danger';
    });
    
    socket.on('show_correct_answer', function(data) {
        resultArea.textContent = `正解は「${data.correct_answer}」でした！`;
        resultArea.className = 'card-footer text-info';
        for (const playerId in data.scores) {
            const scoreEl = document.querySelector(`#score-${playerId} .badge`);
            if (scoreEl) scoreEl.textContent = data.scores[playerId];
        }
    });

    socket.on('game_over', function(data) {
        qText.textContent = data.message;
        optsArea.innerHTML = '';
        resultArea.textContent = `優勝は ${data.winner} さんです！`;
    });
});
</script>
</body>
</html>
