<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ opponent.username }}とのチャット - TMHKchat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        html, body { height: 100%; overflow: hidden; }
        body { display: flex; flex-direction: column; background-color: #E5DDD5; }
        .chat-header { flex-shrink: 0; background-color: #005E54; color: white; }
        .chat-container-wrapper { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .message-row { display: flex; flex-direction: column; margin-bottom: 2px; }
        .my-message-row { align-items: flex-end; }
        .opponent-message-row { align-items: flex-start; }
        .message-bubble { max-width: 70%; padding: 6px 12px; border-radius: 8px; word-wrap: break-word; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); cursor: pointer; }
        .my-message-row .message-bubble { background-color: #DCF8C6; }
        .opponent-message-row .message-bubble { background-color: #FFFFFF; }
        .message-content { padding-bottom: 15px; }
        .message-meta { position: absolute; bottom: 4px; right: 8px; font-size: 0.7em; color: #999; }
        .chat-form { flex-shrink: 0; background-color: #f0f0f0; }
        
        .voice-message-player { width: 250px; }
        .recording-ui { display: none; align-items: center; justify-content: space-between; width: 100%; padding: 5px; }
        .recording-indicator { color: #dc3545; }
    </style>
</head>
<body>
    <header class="chat-header p-2 border-bottom d-flex justify-content-between align-items-center">
        <a href="{{ url_for('main_app') }}" class="btn btn-link text-white"><i class="bi bi-arrow-left"></i></a>
        <strong class="ml-2">{{ opponent.username }}</strong>
        <div></div>
    </header>

    <div class="chat-container-wrapper" id="chat-container-wrapper">
        <div id="chat-container">
        {% for message in messages %}
            <div id="message-row-{{ message.id }}" class="message-row {{ 'my-message-row' if message.sender_id == current_user.id else 'opponent-message-row' }}">
                <div class="message-bubble" data-message-id="{{ message.id }}" data-sender-id="{{ message.sender_id }}">
                    <div class="message-content">
                        {% if message.message_type == 'voice' %}
                            <audio controls class="voice-message-player">
                                <source src="{{ url_for('static', filename='assets/uploads/' + message.content) }}" type="audio/webm">
                                お使いのブラウザは音声をサポートしていません。
                            </audio>
                        {% else %}
                            {{ message.content | nl2br }}
                        {% endif %}
                    </div>
                    <div class="message-meta">{{ message.timestamp | format_datetime('%H:%M') }}</div>
                </div>
            </div>
        {% endfor %}
        </div>
    </div>
    
    <div class="chat-form p-2 bg-light border-top">
        <form id="message-form">
            <div class="input-group">
                <input type="text" id="message-input" class="form-control" placeholder="メッセージを入力..." autocomplete="off">
                <div class="input-group-append">
                    <button class="btn btn-secondary" type="button" id="record-button"><i class="bi bi-mic-fill"></i></button>
                    <button class="btn btn-primary" type="submit" id="send-button"><i class="bi bi-send"></i></button>
                </div>
            </div>
        </form>
        <div class="recording-ui" id="recording-ui">
            <span class="recording-indicator"><i class="bi bi-record-circle"></i> 録音中...</span>
            <span id="recording-timer">00:00</span>
            <button class="btn btn-danger btn-sm" type="button" id="stop-recording-button">送信</button>
            <button class="btn btn-secondary btn-sm" type="button" id="cancel-recording-button">キャンセル</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const chatContainerWrapper = document.getElementById('chat-container-wrapper');
    const chatContainer = document.getElementById('chat-container');
    const opponentId = {{ opponent.id }};
    const currentUserId = {{ current_user.id }};

    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const recordButton = document.getElementById('record-button');
    const recordingUi = document.getElementById('recording-ui');
    const stopRecordingButton = document.getElementById('stop-recording-button');
    const cancelRecordingButton = document.getElementById('cancel-recording-button');
    const recordingTimer = document.getElementById('recording-timer');
    
    let mediaRecorder;
    let audioChunks = [];
    let timerInterval;

    function scrollToBottom() {
        chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
    }
    scrollToBottom();

    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (messageInput.value) {
            socket.emit('send_private_message', { 
                'recipient_id': opponentId, 
                'message': messageInput.value,
                'message_type': 'text'
            });
            messageInput.value = '';
        }
    });

    recordButton.addEventListener('click', async () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('お使いのブラウザは音声録音に対応していません。');
            return;
        }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            startRecording(stream);
        } catch (err) {
            alert('マイクへのアクセス許可が必要です。');
        }
    });

    function startRecording(stream) {
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            uploadVoiceMessage(audioBlob);
            stream.getTracks().forEach(track => track.stop());
        };

        messageForm.style.display = 'none';
        recordingUi.style.display = 'flex';
        
        let startTime = Date.now();
        timerInterval = setInterval(() => {
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            const minutes = String(Math.floor(elapsedTime / 60)).padStart(2, '0');
            const seconds = String(elapsedTime % 60).padStart(2, '0');
            recordingTimer.textContent = `${minutes}:${seconds}`;
        }, 1000);
        
        mediaRecorder.start();
    }

    function stopRecording(cancel = false) {
        clearInterval(timerInterval);
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            if (!cancel) {
                mediaRecorder.stop();
            } else {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }
        recordingUi.style.display = 'none';
        messageForm.style.display = 'block';
    }

    stopRecordingButton.addEventListener('click', () => stopRecording(false));
    cancelRecordingButton.addEventListener('click', () => stopRecording(true));

    async function uploadVoiceMessage(blob) {
        const formData = new FormData();
        formData.append('voice_file', blob);

        try {
            const response = await fetch('/upload_voice', { method: 'POST', body: formData });
            const result = await response.json();
            if (result.success) {
                socket.emit('send_private_message', {
                    'recipient_id': opponentId, 'message': result.file_url, 'message_type': 'voice'
                });
            } else {
                alert('音声メッセージの送信に失敗しました: ' + result.message);
            }
        } catch (error) {
            alert('音声メッセージの送信中にエラーが発生しました。');
        }
    }

    socket.on('new_private_message', (msg) => {
        if ((msg.sender_id == opponentId && msg.recipient_id == currentUserId) || 
            (msg.sender_id == currentUserId && msg.recipient_id == opponentId)) {
            
            let messageContentHTML = '';
            if (msg.message_type === 'voice') {
                const audioSrc = `/static/assets/uploads/${msg.content}`;
                messageContentHTML = `<audio controls class="voice-message-player"><source src="${audioSrc}" type="audio/webm"></audio>`;
            } else {
                messageContentHTML = document.createTextNode(msg.content).textContent.replace(/\\n/g, '<br>');
            }

            const msgRowHTML = `
            <div id="message-row-${msg.id}" class="message-row ${msg.sender_id == currentUserId ? 'my-message-row' : 'opponent-message-row'}">
                <div class="message-bubble" data-message-id="${msg.id}" data-sender-id="${msg.sender_id}">
                    <div class="message-content">${messageContentHTML}</div>
                    <div class="message-meta">
                        ${new Date(msg.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                </div>
            </div>`;
            chatContainer.innerHTML += msgRowHTML;
            scrollToBottom();
        }
    });
});
</script>
</body>
</html>
