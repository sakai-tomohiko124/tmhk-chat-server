<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>あみだくじ - TMHKchat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
<div class="container my-4">
    <a href="{{ url_for('games_hub') }}" class="btn btn-secondary mb-3"><i class="bi bi-arrow-left"></i> 戻る</a>
    <h1 class="text-center">あみだくじ</h1>
    
    <div class="row">
        <div class="col-md-6">
            <h4>参加者</h4>
            <ul class="list-group">
                {% for player in room.players %}
                <li class="list-group-item">{{ player.name }}</li>
                {% endfor %}
            </ul>
        </div>
        <div class="col-md-6">
            <h4>くじの内容</h4>
            {% if room.host == current_user.id %}
            <form id="amida-setup-form">
                <div id="item-inputs">
                    {% for player in room.players %}
                    <div class="form-group">
                        <input type="text" class="form-control" name="item" placeholder="くじ{{ loop.index }}" required>
                    </div>
                    {% endfor %}
                </div>
                <button type="submit" class="btn btn-info">くじを設定</button>
            </form>
            {% endif %}
            <ul id="item-list" class="list-group mt-3"></ul>
        </div>
    </div>
    
    {% if room.host == current_user.id %}
    <div class="text-center mt-4">
        <button id="start-amida-btn" class="btn btn-success btn-lg">あみだ開始！</button>
    </div>
    {% endif %}

    <div id="result-area" class="mt-4"></div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const roomId = "{{ room_id }}";
    const setupForm = document.getElementById('amida-setup-form');
    const startBtn = document.getElementById('start-amida-btn');
    const itemList = document.getElementById('item-list');
    const resultArea = document.getElementById('result-area');

    if (setupForm) {
        setupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const items = Array.from(e.target.elements.item).map(input => input.value);
            socket.emit('setup_amida', { room_id: roomId, items: items });
        });
    }

    if (startBtn) {
        startBtn.addEventListener('click', () => {
            socket.emit('start_amida', { room_id: roomId });
        });
    }

    socket.on('amida_updated', function(data) {
        itemList.innerHTML = '';
        data.items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = item;
            itemList.appendChild(li);
        });
    });

    socket.on('amida_result', function(data) {
        resultArea.innerHTML = '<h3 class="text-center">結果発表！</h3>';
        const table = document.createElement('table');
        table.className = 'table table-bordered';
        table.innerHTML = '<thead class="thead-dark"><tr><th>参加者</th><th>結果</th></tr></thead>';
        const tbody = document.createElement('tbody');
        
        const playerMap = { {% for p in room.players %}{{ p.id }}: '{{ p.name }}',{% endfor %} };

        for (const playerId in data.results) {
            const row = document.createElement('tr');
            const playerName = playerMap[playerId] || '不明';
            row.innerHTML = `<td>${playerName}</td><td>${data.results[playerId]}</td>`;
            tbody.appendChild(row);
        }
        table.appendChild(tbody);
        resultArea.appendChild(table);
    });
});
</script>
</body>
</html>
