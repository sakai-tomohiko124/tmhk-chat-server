<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMHKchat</title>
    
    <!-- 外部ライブラリの読み込み -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <!-- 【重要】分離したCSSファイルをここで読み込みます -->
    <!-- 不要な <style> タグはここにはありません -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main_app.css') }}">
</head>
<body style="background: {{ theme.bg_gradient }};">
<div class="app-container">
    <header class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h1 id="header-title" class="h4 mb-0">ホーム</h1>
        <div>
            <a href="{{ url_for('friends_page') }}" class="btn btn-light"><i class="bi bi-person-plus"></i></a>
            <a href="{{ url_for('settings_page') }}" class="btn btn-light"><i class="bi bi-gear"></i></a>
        </div>
    </header>

    <main class="main-content p-3">
        <!-- ホームタブ -->
        <section id="home-tab" class="tab-content active">
            <a href="{{ url_for('profile_edit_page') }}" class="text-dark">
                <div class="d-flex align-items-center mb-4">
                    <div class="status-indicator-container status-online" data-user-id="{{ current_user.id }}">
                         <img src="{{ url_for('static', filename='assets/uploads/profile_images/' + current_user.profile_image if 'user' in current_user.profile_image else 'assets/images/' + current_user.profile_image) }}" alt="avatar" class="rounded-circle" width="60" height="60">
                         <div class="status-indicator"></div>
                    </div>
                    <div class="ml-3">
                        <h5 class="mb-0">{{ current_user.username }}</h5>
                        <p class="text-muted mb-0">{{ current_user.status_message }}</p>
                    </div>
                </div>
            </a>
            <div class="service-grid">
                <a href="{{ url_for('profile_edit_page') }}"><div class="service-item"><i class="bi bi-person-circle"></i><span>マイプロフィール</span></div></a>
                <a href="{{ url_for('friends_page') }}"><div class="service-item"><i class="bi bi-people-fill"></i><span>友達リスト</span></div></a>
                <a href="{{ url_for('games_hub') }}"><div class="service-item"><i class="bi bi-controller"></i><span>ミニゲーム</span></div></a>
                <a href="{{ url_for('settings_page') }}"><div class="service-item"><i class="bi bi-gear-fill"></i><span>設定</span></div></a>
                <a href="{{ url_for('friends_page') }}"><div class="service-item"><i class="bi bi-person-plus-fill"></i><span>友達追加</span></div></a>
                <a href="{{ url_for('stamps_page') }}"><div class="service-item"><i class="bi bi-emoji-smile-fill"></i><span>スタンプ</span></div></a>
                <a href="{{ url_for('ai_chat_page') }}"><div class="service-item"><i class="bi bi-robot"></i><span>AIボット</span></div></a>
                <a href="{{ url_for('survey_page') }}"><div class="service-item"><i class="bi bi-clipboard-check"></i><span>アンケート</span></div></a>
                <a href="{{ url_for('youtube_redirect') }}" target="_blank"><div class="service-item"><i class="bi bi-youtube" style="color:red;"></i><span>YouTube</span></div></a>
                <a href="{{ url_for('gmail_redirect') }}" target="_blank"><div class="service-item"><i class="bi bi-envelope-fill" style="color:grey;"></i><span>Gmail</span></div></a>
                <a href="{{ url_for('announcements_page') }}"><div class="service-item"><i class="bi bi-megaphone-fill"></i><span>お知らせ</span></div></a>
                <a href="{{ url_for('keep_memo') }}"><div class="service-item"><i class="bi bi-journal-check"></i><span>キープメモ</span></div></a>
            </div>
            <h5><i class="bi bi-star-fill text-warning"></i> お気に入り</h5>
            <ul class="list-group mb-4">
                {% for friend in favorite_friends %}
                <a href="{{ url_for('start_chat_with', user_id=friend.id) }}" class="list-group-item">
                    <div class="status-indicator-container in-list status-offline" data-user-id="{{ friend.id }}">
                        <div class="status-indicator"></div>
                        <span>{{ friend.username }}</span>
                    </div>
                </a>
                {% else %}
                <li class="list-group-item">お気に入りの友達はいません。</li>
                {% endfor %}
            </ul>
            <h5><i class="bi bi-people"></i> 友達</h5>
            <ul class="list-group">
                {% for friend in normal_friends %}
                <a href="{{ url_for('start_chat_with', user_id=friend.id) }}" class="list-group-item">
                     <div class="status-indicator-container in-list status-offline" data-user-id="{{ friend.id }}">
                        <div class="status-indicator"></div>
                        <span>{{ friend.username }}</span>
                    </div>
                </a>
                {% else %}
                <li class="list-group-item">友達はいません。</li>
                {% endfor %}
            </ul>
        </section>

        <!-- トークタブ -->
        <section id="talk-tab" class="tab-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>トーク</h3>
                <select id="talk-filter-select" class="form-control" style="width: auto;">
                    <option value="individual" {% if current_filter == 'individual' %}selected{% endif %}>個人</option>
                    <option value="groups" {% if current_filter == 'groups' %}selected{% endif %}>グループ</option>
                    <option value="close_friends" {% if current_filter == 'close_friends' %}selected{% endif %}>親しい友達</option>
                    <option value="acquaintances" {% if current_filter == 'acquaintances' %}selected{% endif %}>知り合い</option>
                    <optgroup label="その他">
                        {% for clist in custom_lists %}
                        <option value="custom_{{ clist.id }}" {% if current_filter == 'custom_' + clist.id|string %}selected{% endif %}>{{ clist.list_name }}</option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>
             <ul class="list-group">
                {% if talk_filter == 'groups' %}
                    {% for group in groups_list %}
                    <a href="#" class="list-group-item list-group-item-action"> <!-- TODO: Add group chat URL -->
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1"><i class="bi bi-people-fill"></i> {{ group.name }}</h5>
                        </div>
                        <p class="mb-1 text-muted">{{ group.last_message[:30] or 'まだメッセージはありません' }}...</p>
                    </a>
                    {% else %}
                    <li class="list-group-item">参加しているグループはありません。</li>
                    {% endfor %}
                {% else %}
                    {% for talk in talks_list %}
                    <a href="{{ url_for('start_chat_with', user_id=talk.partner_id) }}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ talk.partner_name }}</h5>
                            <small>{{ talk.last_message_time | format_datetime }}</small>
                        </div>
                        <p class="mb-1 text-muted">{{ talk.last_message_content[:30] }}...</p>
                        {% if talk.unread_count > 0 %}<span class="badge badge-danger badge-pill">{{ talk.unread_count }}</span>{% endif %}
                    </a>
                    {% else %}
                    <li class="list-group-item">トーク履歴がありません。</li>
                    {% endfor %}
                {% endif %}
            </ul>
        </section>
        
        <!-- タイムラインタブ -->
        <section id="timeline-tab" class="tab-content" style="overflow-y: auto; height: 100%; padding-bottom: 50px;">
        <div class="card mb-3">
        <div class="card-header">リアルタイム情報</div>
        <div class="card-body" style="font-size: 0.9em;">
        <p class="mb-1"><strong>天気:</strong> {% for w in weather_data %}{{ w.data }}{% endfor %} <a href="https://www.jma.go.jp/bosai/forecast/#area_type=offices&area_code=130000" target="_blank" class="small">(気象庁)</a></p>
        <p class="mb-1"><strong>交通:</strong> {{ traffic.data if traffic else '情報なし' }} <a href="https://traininfo.jreast.co.jp/train_info/kanto.aspx" target="_blank" class="small">(JR東日本)</a></p>
        <p class="mb-0"><strong>災害:</strong> {{ disaster.data if disaster else '情報なし' }} <a href="https://www.jma.go.jp/bosai/warning/#area_type=offices&area_code=130000" target="_blank" class="small">(気象庁)</a></p>
        </div>
        </div>
            <div class="card mb-3">
                <div class="card-body">
                    <form action="{{ url_for('post_timeline') }}" method="post" enctype="multipart/form-data">
                        <div class="form-group">
                            <textarea name="content" class="form-control" rows="2" placeholder="今なにしてる？"></textarea>
                        </div>
                        <div class="form-group mb-2">
                            <input type="file" name="media" class="form-control-file">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">投稿</button>
                    </form>
                </div>
            </div>
            {% for post in posts %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-start">
                        <img src="{{ url_for('static', filename='assets/uploads/profile_images/' + post.profile_image if 'user' in post.profile_image else 'assets/images/' + post.profile_image) }}" class="rounded-circle mr-3" width="50" height="50">
                        <div>
                            <h5 class="card-title mb-1">{{ post.username }}</h5>
                            <p class="card-text">{{ post.content | nl2br }}</p>
                            {% if post.media_url %}
                                {% if post.media_url.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
                                    <img src="{{ url_for('static', filename='assets/uploads/' + post.media_url) }}" class="img-fluid rounded mb-2" style="max-height: 300px;">
                                {% elif post.media_url.lower().endswith(('.mp4', '.mov', '.avi')) %}
                                    <video src="{{ url_for('static', filename='assets/uploads/' + post.media_url) }}" class="img-fluid rounded mb-2" controls style="max-height: 300px;"></video>
                                {% endif %}
                            {% endif %}
                            <small class="text-muted">{{ post.created_at | format_datetime }}</small>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <p>まだ投稿がありません。</p>
            {% endfor %}
        </section>
        <!-- その他タブ -->
        <section id="other-tab" class="tab-content">
            <ul class="list-group">
                <a href="{{ url_for('settings_page') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div><i class="bi bi-gear-fill mr-2"></i>全体設定</div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="{{ url_for('auto_replies_page') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div><i class="bi bi-robot mr-2"></i>自動応答メッセージ設定</div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="{{ url_for('canned_messages_page') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div><i class="bi bi-body-text mr-2"></i>定型文設定</div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                 <a href="{{ url_for('block_list_page') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div><i class="bi bi-slash-circle-fill mr-2"></i>ブロックリスト</div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="{{ url_for('hidden_list_page') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div><i class="bi bi-eye-slash-fill mr-2"></i>非表示リスト</div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="{{ url_for('custom_lists_page') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div><i class="bi bi-person-lines-fill mr-2"></i>カスタムリスト管理</div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                {% if current_user.is_admin %}
                <a href="{{ url_for('admin_message_viewer') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center list-group-item-warning">
                    <div><i class="bi bi-envelope-paper-fill mr-2"></i><strong>（管理者）メッセージ閲覧</strong></div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="{{ url_for('admin_survey_viewer') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center list-group-item-warning">
                    <div><i class="bi bi-card-checklist mr-2"></i><strong>（管理者）アンケート結果</strong></div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="{{ url_for('admin_dashboard') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center list-group-item-danger">
                    <div><i class="bi bi-shield-lock-fill mr-2"></i><strong>（管理者）ユーザー管理</strong></div>
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="{{ url_for('admin_message_viewer') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center list-group-item-warning">
                    
                {% endif %}
            </ul>
 <div class="mt-4">
                 <a href="{{ url_for('index_loading') }}" class="btn btn-info btn-block">スタート画面へ</a>
            </div>
            <div class="mt-4">
                 <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-block">ログアウト</a>
            </div>
            {% if current_user.is_admin %}
            <div class="mt-4">
                <button onclick="shutdownServer()" class="btn btn-danger btn-block">サーバーを終了して閉じる</button> 
            </div>
            {% endif %}
        </section>

    </main>

    <nav class="tab-navigation d-flex justify-content-around p-2 bg-light">
        <button data-tab="home-tab" class="nav-button btn btn-link active"><i class="bi bi-house-door-fill"></i><div>ホーム</div></button>
        <button data-tab="talk-tab" class="nav-button btn btn-link"><i class="bi bi-chat-fill"></i><div>トーク</div></button>
        <button data-tab="timeline-tab" class="nav-button btn btn-link"><i class="bi bi-clock-history"></i><div>タイムライン</div></button>
        <button data-tab="other-tab" class="nav-button btn btn-link"><i class="bi bi-three-dots"></i><div>その他</div></button>
    </nav>
</div>

<script>
    // Python(Jinja2)からJavaScriptへ変数を渡すための設定
    const currentUserId = {{ current_user.id }};
    const friends_page_url = "{{ url_for('friends_page') }}";
</script>

<!-- 分離したJavaScriptファイルを読み込む -->
<script src="{{ url_for('static', filename='js/main_app.js') }}"></script>
</body>
</html>