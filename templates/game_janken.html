<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>じゃんけん - TMHKchat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .game-container { max-width: 500px; margin: auto; }
        .hand-display { font-size: 5rem; text-align: center; height: 120px; line-height: 120px; }
        .player-area { border: 2px dashed #ccc; border-radius: 10px; padding: 20px; }
        .vs { font-size: 3rem; font-weight: bold; }
        .hand-buttons button { width: 80px; height: 80px; font-size: 2.5rem; }
        .result-text { font-size: 1.5rem; font-weight: bold; height: 50px; }
    </style>
</head>
<body>
<div class="container my-4 game-container">
    <a href="{{ url_for('games_hub') }}" class="btn btn-secondary mb-3"><i class="bi bi-arrow-left"></i> 戻る</a>
    <h1 class="text-center">じゃんけん</h1>
    
    <div class="row align-items-center text-center">
        <div class="col-12 mb-3">
            <div class="player-area">
                <h6>{{ room.players[1].name }}</h6>
                <div id="opponent-hand" class="hand-display text-secondary">？</div>
            </div>
        </div>
        
        <div class="col-12 my-2">
            <div class="vs">VS</div>
        </div>

        <div class="col-12 mt-3">
            <div class="player-area bg-light">
                 <h6>{{ current_user.username }} (あなた)</h6>
                 <div id="my-hand" class="hand-display text-secondary">？</div>
            </div>
        </div>
    </div>
    
    <div id="result-area" class="text-center my-3 result-text text-primary">
        手を選んでください
    </div>

    <div id="hand-buttons" class="text-center">
        <button class="btn btn-outline-primary" data-move="rock"><i class="bi bi-hand-thumbs-up-fill"></i></button>
        <button class="btn btn-outline-success mx-3" data-move="scissors"><i class="bi bi-scissors"></i></button>
        <button class="btn btn-outline-warning" data-move="paper"><i class="bi bi-hand-index-thumb-fill"></i></button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const roomId = "{{ room_id }}";
    const handButtons = document.getElementById('hand-buttons');
    const myHandDiv = document.getElementById('my-hand');
    const opponentHandDiv = document.getElementById('opponent-hand');
    const resultArea = document.getElementById('result-area');
    const handIcons = {
        'rock': '<i class="bi bi-hand-thumbs-up-fill"></i>',
        'scissors': '<i class="bi bi-scissors"></i>',
        'paper': '<i class="bi bi-hand-index-thumb-fill"></i>'
    };

    handButtons.addEventListener('click', function(e) {
        const button = e.target.closest('button');
        if (button) {
            const move = button.dataset.move;
            socket.emit('janken_move', { room_id: roomId, move: move });
            myHandDiv.innerHTML = handIcons[move];
            resultArea.textContent = '相手が出すのを待っています...';
            handButtons.style.display = 'none';
        }
    });

    socket.on('janken_result', function(data) {
        const myMove = data.moves[{{ current_user.id }}];
        const opponentId = Object.keys(data.moves).find(id => parseInt(id, 10) !== {{ current_user.id }});
        const opponentMove = data.moves[opponentId];
        
        myHandDiv.innerHTML = handIcons[myMove];
        opponentHandDiv.innerHTML = handIcons[opponentMove];
        resultArea.textContent = data.result_text;

        setTimeout(() => {
            myHandDiv.innerHTML = '？';
            opponentHandDiv.innerHTML = '？';
            resultArea.textContent = 'もう一度！';
            handButtons.style.display = 'block';
        }, 2000);
    });
});
</script>
</body>
</html>
