{% extends "base.html" %}

{% block title %}接続中...{% endblock %}

{% block head_style %}
<style>
    /* メインのコンテンツコンテナ */
    .container {
        text-align: center;
        opacity: 0; /* GSAPでのアニメーションのため初期状態は非表示 */
    }

    /* タイトル */
    h1 {
        font-size: 2.5rem;
        color: #fff;
    }

    /* 説明文 */
    p {
        font-size: 1.2rem;
        opacity: 0.8;
    }
    
    /* 3Dローダーを描画するエリア */
    #loader-3d {
        margin-bottom: 2rem;
        /* canvasのサイズはJavaScript側で設定 */
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div id="loader-3d"></div>
    <h1>TMHKchat(仮)</h1>
    <p>ニューラルネットワーク開始中...</p>
</div>
<script>
    // 2秒後にnextパラメータがあれば遷移、なければログイン画面へ
    setTimeout(function() {
        const params = new URLSearchParams(window.location.search);
        const next = params.get('next');
        if (next) {
            window.location.href = next;
        } else {
            window.location.href = '/login';
        }
    }, 2000);
</script>
{% endblock %}

{% block body_script %}
<script>
    // GSAPを使ってコンテナをフェードインさせる
    gsap.to(".container", {
        duration: 1,
        opacity: 1,
        ease: "power2.inOut"
    });

    // Three.jsで3Dローダーを作成
    // (base.htmlの背景とは別の、独立したScene)
    const loaderScene = new THREE.Scene();
    const loaderCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000); // アスペクト比は1:1
    const loaderRenderer = new THREE.WebGLRenderer({
        alpha: true, // 背景を透過
        antialias: true // エッジを滑らかに
    });

    loaderRenderer.setSize(150, 150);
    document.getElementById('loader-3d').appendChild(loaderRenderer.domElement);

    // IcosahedronGeometry (正二十面体) を作成
    const geometry = new THREE.IcosahedronGeometry(1, 0); 
    const material = new THREE.MeshStandardMaterial({
        color: 0x9f78ff, // --primary-color
        emissive: 0x9f78ff, // 自己発光色
        emissiveIntensity: 0.5,
        wireframe: true, // ワイヤーフレーム表示
    });
    const mesh = new THREE.Mesh(geometry, material);
    loaderScene.add(mesh);

    // 光源を追加
    const pointLight = new THREE.PointLight(0xffffff, 1);
    pointLight.position.set(5, 5, 5);
    loaderScene.add(pointLight);
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
    loaderScene.add(ambientLight);

    loaderCamera.position.z = 3;

    // 3Dオブジェクトを回転させるアニメーションループ
    function animateLoader() {
        requestAnimationFrame(animateLoader);
        mesh.rotation.x += 0.01;
        mesh.rotation.y += 0.01;
        loaderRenderer.render(loaderScene, loaderCamera);
    }
    animateLoader();
    
    // 3秒後にページ遷移
    setTimeout(() => {
        // コンテナをフェードアウトさせる
        gsap.to(".container", {
            duration: 1,
            opacity: 0,
            ease: "power2.inOut",
            // アニメーション完了後に関数を実行
            onComplete: () => {
                window.location.href = "{{ url_for('terms') }}";
            }
        });
    }, 3000); // 3000ミリ秒 = 3秒
</script>
{% endblock %}